<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense Data Store</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin:0; padding:20px; position:relative; }
h1 { text-align:center; color:#333; }
form { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px; }
input, button { padding:10px 15px; font-size:14px; border-radius:5px; border:1px solid #ccc; }
button { cursor:pointer; background:#007bff; color:white; border:none; transition:0.3s; }
button:hover { background:#0056b3; }
table { width:100%; border-collapse:collapse; margin-bottom:15px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
th, td { padding:12px 8px; text-align:left; }
th { background:#007bff; color:white; font-weight:600; }
tbody tr:nth-child(even) { background:#f9f9f9; }
tbody tr:hover { background:#e1f0ff; }
button.edit { background:#ffc107; color:#333; }
button.edit:hover { background:#e0a800; }
button.delete { background:#dc3545; color:white; }
button.delete:hover { background:#c82333; }
#total, .daily-total { font-weight:bold; margin:5px 0; padding:8px; background:#fff; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.export-buttons, #savedRecords { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:15px; }
.saved-record { background:#fff; padding:8px 12px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); width:100%; max-width:500px; }
.saved-record button { margin-left:5px; margin-top:5px; }
.record-details { margin-top:10px; display:none; border-top:1px solid #ccc; padding-top:5px; }
.record-details table { width:100%; border-collapse:collapse; }
.record-details th, .record-details td { border:1px solid #ccc; padding:5px; }
#searchBox { width:100%; max-width:500px; padding:8px; margin:10px auto; display:block; border:1px solid #ccc; border-radius:5px; }
#clearFields { position:absolute; top:20px; left:20px; background:#28a745; color:white; padding:8px 12px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
#cumulativeTotal { position:absolute; top:20px; right:20px; background:#ffc107; padding:8px 12px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.2); font-weight:bold; }
#lockScreen { position:fixed; inset:0; background:#0f172a; display:flex; align-items:center; justify-content:center; z-index:9999; color:white; flex-direction:column; }
#lockScreen input { width:80%; padding:10px; border-radius:8px; border:none; margin-bottom:10px; text-align:center; }
#lockScreen button { width:50%; padding:10px; border-radius:8px; border:none; background:#2563eb; color:white; cursor:pointer; font-weight:bold; }
#lockMsg { margin-top:10px; color:#f87171; font-weight:bold; text-align:center; }
@media(max-width:600px){ form { flex-direction:column; align-items:stretch; } input, button { width:100%; } #clearFields, #cumulativeTotal { position:static; margin:5px auto; } }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div id="lockScreen">
    <input type="password" id="passcodeInput" placeholder="Enter Passcode"/>
    <button onclick="unlockApp()">Unlock</button>
    <div id="lockMsg"></div>
</div>

<div class="container" style="display:none;">
<h1>Expense Data Store</h1>

<form id="expenseForm">
    <input type="text" id="itemName" placeholder="Item Name" required>
    <input type="number" step="0.01" id="costPrice" placeholder="Cost (UGX)" required>
    <button type="submit">Add Expense</button>
</form>

<div id="dailyTotals"></div>
<div id="total"></div>
<input type="text" id="searchBox" placeholder="Search Saved Records">
<div id="savedRecords"></div>
<button id="saveRecordBtn">Save Record</button>
<button id="updateRecordBtn" style="display:none;">Update Record</button>
<button id="clearFields">Clear Fields</button>
<div id="cumulativeTotal">Total Saved Records: UGX 0.00</div>
</div>

<script>
// ===== FIREBASE CONFIG =====
var firebaseConfig = {
  apiKey: "AIzaSyBIqH5OqLlsFEcFU33CGMQ2yzKEzlN0QH8",
  authDomain: "personal-saving-app.firebaseapp.com",
  databaseURL: "https://personal-saving-app-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "personal-saving-app",
  storageBucket: "personal-saving-app.firebasestorage.app",
  messagingSenderId: "255115128182",
  appId: "1:255115128182:web:8a8a9e411ca8732f355e57",
  measurementId: "G-W262YENVK3"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// ===== LOCK SCREEN =====
var lockScreen = document.getElementById('lockScreen');
var container = document.querySelector('.container');
var passInput = document.getElementById('passcodeInput');
var lockMsg = document.getElementById('lockMsg');
function unlockApp() {
    if(passInput.value === '1975'){
        lockScreen.style.display='none';
        container.style.display='block';
        initApp();
    } else {
        lockMsg.textContent = "Wrong Passcode!";
    }
}

// ===== MAIN APP =====
function initApp() {
const expenseForm = document.getElementById('expenseForm');
const expenseTableBody = document.querySelector('#expenseTable tbody');
const dailyTotalsDiv = document.getElementById('dailyTotals');
const totalDiv = document.getElementById('total');
const savedRecordsDiv = document.getElementById('savedRecords');
const saveRecordBtn = document.getElementById('saveRecordBtn');
const updateRecordBtn = document.getElementById('updateRecordBtn');
const searchBox = document.getElementById('searchBox');
const clearFieldsBtn = document.getElementById('clearFields');
const cumulativeDiv = document.getElementById('cumulativeTotal');

let expenses = [];
let savedRecords = [];
let editIndex = -1;
let currentRecordIndex = -1;

// ===== HELPER FUNCTIONS =====
function updateCumulativeTotal() {
    var sum = 0;
    savedRecords.forEach(r=> r.expenses.forEach(e=> sum += parseFloat(e.cost)));
    cumulativeDiv.textContent = 'Total Saved Records: UGX ' + sum.toFixed(2);
}

function updateTable() {
    if(!document.querySelector('#expenseTable')){
        var tbl = document.createElement('table');
        tbl.id='expenseTable';
        tbl.innerHTML='<thead><tr><th>Date & Time</th><th>Item</th><th>Cost (UGX)</th><th>Action</th></tr></thead><tbody></tbody>';
        container.insertBefore(tbl,dailyTotalsDiv);
    }
    const tbody = document.querySelector('#expenseTable tbody');
    tbody.innerHTML='';
    var overallTotal = 0;
    var dailySums = {};
    expenses.forEach((exp,i)=>{
        overallTotal += exp.cost;
        var dateOnly = exp.date.split(',')[0];
        dailySums[dateOnly] = (dailySums[dateOnly] || 0) + exp.cost;
        var row = document.createElement('tr');
        row.innerHTML = `<td>${exp.date}</td><td>${exp.item}</td><td>UGX ${exp.cost.toFixed(2)}</td>
            <td><button class="edit">Edit</button><button class="delete">Delete</button></td>`;
        row.querySelector('.edit').onclick = function(){
            document.getElementById('itemName').value = exp.item;
            document.getElementById('costPrice').value = exp.cost;
            editIndex = i;
        };
        row.querySelector('.delete').onclick = function(){
            expenses.splice(i,1);
            db.ref('expenses').set(expenses);
        };
        tbody.appendChild(row);
    });
    totalDiv.textContent = 'Overall Total: UGX '+overallTotal.toFixed(2);
    dailyTotalsDiv.innerHTML='';
    for(var date in dailySums){
        var div = document.createElement('div');
        div.className='daily-total';
        div.textContent='Total for '+date+': UGX '+dailySums[date].toFixed(2);
        dailyTotalsDiv.appendChild(div);
    }
}

function updateSavedRecords(filter=''){
    savedRecordsDiv.innerHTML='';
    savedRecords.forEach((record,i)=>{
        if(!record.name) record.name = 'Record '+(i+1);
        if(filter && !record.name.toLowerCase().includes(filter.toLowerCase())) return;
        var div = document.createElement('div');
        div.className='saved-record';
        div.innerHTML = `<strong>${record.name}</strong>
            <button class="toggle">View</button>
            <button class="editRecord">Edit</button>
            <button class="deleteRecord">Delete</button>
            <div class="record-details"></div>`;
        var detailsDiv = div.querySelector('.record-details');

        div.querySelector('.toggle').onclick = function(){
            if(detailsDiv.style.display==='none'){
                detailsDiv.innerHTML='<table><thead><tr><th>Date & Time</th><th>Item</th><th>Cost (UGX)</th></tr></thead><tbody>'+
                    record.expenses.map(e=>`<tr><td>${e.date}</td><td>${e.item}</td><td>UGX ${e.cost.toFixed(2)}</td></tr>`).join('')+'</tbody></table>';
                detailsDiv.style.display='block';
            } else detailsDiv.style.display='none';
        };

        div.querySelector('.editRecord').onclick = function(){
            expenses = JSON.parse(JSON.stringify(record.expenses));
            currentRecordIndex = i;
            updateTable();
            updateRecordBtn.style.display='inline-block';
            saveRecordBtn.style.display='none';
        };

        div.querySelector('.deleteRecord').onclick = function(){
            if(confirm('Delete this saved record?')){
                savedRecords.splice(i,1);
                db.ref('savedRecords').set(savedRecords);
            }
        };

        savedRecordsDiv.appendChild(div);
    });
}

// ===== FIREBASE SYNC =====
db.ref('expenses').on('value', function(snapshot){
    expenses = snapshot.val() || [];
    updateTable();
});
db.ref('savedRecords').on('value', function(snapshot){
    savedRecords = snapshot.val() || [];
    updateSavedRecords();
    updateCumulativeTotal();
});

// ===== EVENTS =====
expenseForm.onsubmit = function(e){
    e.preventDefault();
    var item = document.getElementById('itemName').value.trim();
    var cost = parseFloat(document.getElementById('costPrice').value);
    if(!item || isNaN(cost)) return;
    var date = new Date().toLocaleString();
    if(editIndex>=0){ expenses[editIndex]={date,item,cost}; editIndex=-1; }
    else expenses.push({date,item,cost});
    db.ref('expenses').set(expenses);
    expenseForm.reset();
};

saveRecordBtn.onclick = function(){
    var recordName = prompt("Enter record name:");
    if(!recordName) return;
    savedRecords.push({name:recordName, expenses:JSON.parse(JSON.stringify(expenses))});
    db.ref('savedRecords').set(savedRecords);
    alert("Record saved successfully!");
};

updateRecordBtn.onclick = function(){
    if(currentRecordIndex>=0){
        var recordName = prompt("Enter updated record name:", savedRecords[currentRecordIndex].name);
        if(!recordName) return;
        savedRecords[currentRecordIndex]={name:recordName, expenses:JSON.parse(JSON.stringify(expenses))};
        currentRecordIndex=-1;
        db.ref('savedRecords').set(savedRecords);
        updateRecordBtn.style.display='none';
        saveRecordBtn.style.display='inline-block';
        alert("Record updated successfully!");
    }
};

searchBox.oninput = function(){ updateSavedRecords(searchBox.value); };
clearFieldsBtn.onclick = function(){ expenseForm.reset(); editIndex=-1; };

// ===== EXPORT =====
function exportToCSV(data,name='records.csv'){
    var headers = ['Date','Item','Cost (UGX)'];
    var csv = [headers.join(',')];
    data.forEach(e=> csv.push([e.date,e.item,e.cost].join(',')));
    var blob = new Blob([csv.join('\n')], {type:'text/csv'});
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = name;
    link.click();
}

function exportToPDF(data,title='Expense Report'){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text(title,14,20);
    let y=30;
    doc.setFontSize(12);
    data.forEach(exp=>{
        doc.text(`${exp.date} | ${exp.item} | UGX ${exp.cost.toFixed(2)}`,14,y);
        y+=8;
        if(y>270){ doc.addPage(); y=20; }
    });
    doc.save(title+'.pdf');
}

// ===== EXPORT BUTTONS =====
var exportDiv = document.createElement('div');
exportDiv.className='export-buttons';
var exportPDFBtn = document.createElement('button');
exportPDFBtn.textContent='Export All PDF';
exportPDFBtn.onclick = function(){ exportToPDF(expenses.concat(...savedRecords.map(r=>r.expenses)),'All Expenses'); };
var exportCSVBtn = document.createElement('button');
exportCSVBtn.textContent='Export All CSV';
exportCSVBtn.onclick = function(){ exportToCSV(expenses.concat(...savedRecords.map(r=>r.expenses)),'all_expenses.csv'); };
exportDiv.append(exportPDFBtn,exportCSVBtn);
container.prepend(exportDiv);

}
</script>
</body>
</html>
